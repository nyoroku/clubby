{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Challenge Status Test - {{ challenge.title }}</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'melvins': {
                            'maroon': '#8b2332',
                            'maroon-dark': '#6a1b27',
                            'gold': '#d4a536',
                            'gold-light': '#e6bc52',
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-100 p-8">

    <nav class="bg-gray-800 text-white rounded-xl p-4 mb-8 shadow-lg">
        <div class="flex items-center gap-2">
            <span class="text-2xl">ğŸ”</span>
            <strong>Challenge Status Diagnostic Tool</strong>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto space-y-6">
        <!-- Header Box -->
        <div class="bg-white rounded-xl shadow p-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-2">{{ challenge.title }}</h1>
            <p class="text-gray-500 mb-6">Challenge ID: <span class="font-mono bg-gray-100 px-2 py-1 rounded">{{
                    challenge.id }}</span></p>

            <div class="flex flex-wrap gap-2">
                <button onclick="refreshStatus()"
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition shadow">
                    ğŸ”„ Refresh Status
                </button>
                <a href="{% url 'club:challenge_detail' challenge.id %}"
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-bold rounded-lg transition shadow">
                    ğŸ“‹ View Challenge
                </a>
                {% if user.is_staff %}
                <a href="{% url 'club:challenge_live_draw' challenge.id %}"
                    class="px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg transition shadow">
                    ğŸ¬ Go to Live Draw
                </a>
                {% endif %}
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Database Status -->
            <div class="bg-white rounded-xl shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ğŸ“Š Database Status</h2>

                <div class="bg-gray-50 rounded-lg p-4 font-mono text-sm space-y-2 border border-gray-200">
                    <div><strong>Challenge Status:</strong> {{ challenge.status }}</div>
                    <div><strong>Draw In Progress:</strong>
                        <span
                            class="{% if challenge.draw_in_progress %}text-red-600 font-bold{% else %}text-gray-600{% endif %}">
                            {{ challenge.draw_in_progress }}
                        </span>
                    </div>
                    <div><strong>Number of Winners:</strong> {{ challenge.number_of_winners }}</div>
                    <div><strong>Winners Selected At:</strong> {{ challenge.winners_selected_at|default:"Not yet" }}
                    </div>
                    <div><strong>Total Entries:</strong> {{ challenge.total_entries|default:"0" }}</div>
                    <div><strong>End Date:</strong> {{ challenge.end_date|date:"M d, Y H:i" }}</div>
                    <div><strong>Is Public Results:</strong> {{ challenge.is_public_results }}</div>
                </div>

                <h3 class="font-bold text-lg mt-6 mb-2">ğŸ† Winners in Database</h3>
                <div
                    class="rounded-lg p-4 text-sm border-l-4 {% if winners_count > 0 %}bg-emerald-50 border-emerald-500 text-emerald-900{% else %}bg-amber-50 border-amber-500 text-amber-900{% endif %}">
                    <p class="font-bold mb-2">Winners Count: {{ winners_count }}</p>
                    {% if winners %}
                    <div class="space-y-2">
                        {% for winner in winners %}
                        <div class="bg-white/50 p-2 rounded">
                            <strong>{{ winner.position }}.</strong> {{ winner.profile.phone }} - {{
                            winner.profile.first_name }}
                            <div class="text-xs opacity-75">Weight: {{ winner.entry_weight|floatformat:2 }} | County: {{
                                winner.profile.get_county_display|default:"N/A" }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <em>No winners in database yet</em>
                    {% endif %}
                </div>

                <h3 class="font-bold text-lg mt-6 mb-2">ğŸ‘¥ Eligible Participants</h3>
                <div class="rounded-lg p-4 text-sm border-l-4 bg-blue-50 border-blue-500 text-blue-900">
                    <p><strong>Eligible Count:</strong> {{ eligible_count }}</p>
                    <p class="mt-1">
                        <strong>Enough for Draw:</strong>
                        {% if eligible_count >= challenge.number_of_winners %}
                        <span class="font-bold text-emerald-600">âœ… Yes ({{ eligible_count }} â‰¥ {{
                            challenge.number_of_winners }})</span>
                        {% else %}
                        <span class="font-bold text-red-600">âŒ No ({{ eligible_count }} < {{ challenge.number_of_winners
                                }})</span>
                                {% endif %}
                    </p>
                </div>
            </div>

            <!-- API Status -->
            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">ğŸ”Œ API Status</h2>

                    <h3 class="font-bold text-sm text-gray-600 mb-2">Winners Status Endpoint:</h3>
                    <code class="block bg-gray-100 p-3 rounded text-xs text-gray-600 mb-4 break-all">
                        GET /club/challenge/{{ challenge.id }}/winners-status/
                    </code>

                    <div id="api-status" class="rounded-lg p-4 font-mono text-sm border-l-4 bg-gray-50 border-gray-300">
                        <em>Loading...</em>
                    </div>

                    <h3 class="font-bold text-sm text-gray-600 mt-6 mb-2">Raw API Response:</h3>
                    <pre id="api-response"
                        class="bg-gray-900 text-emerald-400 p-4 rounded-lg text-xs overflow-x-auto h-32"></pre>

                    <h3 class="font-bold text-sm text-gray-600 mt-6 mb-2">ğŸ”— Quick Links:</h3>
                    <div class="flex flex-wrap gap-2">
                        <a href="{% url 'club:challenge_detail' challenge.id %}"
                            class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 text-sm font-bold"
                            target="_blank">Challenge Detail</a>
                        <a href="{% url 'club:public_challenge_live_stream' challenge.id %}"
                            class="px-3 py-1 bg-amber-100 text-amber-700 rounded hover:bg-amber-200 text-sm font-bold"
                            target="_blank">Public Watch Page</a>
                        {% if challenge.status == 'winners_selected' %}
                        <a href="{% url 'club:challenge_winners' challenge.id %}"
                            class="px-3 py-1 bg-emerald-100 text-emerald-700 rounded hover:bg-emerald-200 text-sm font-bold"
                            target="_blank">Winners Page</a>
                        {% endif %}
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 border-b pb-2">âš¡ Quick Actions</h2>

                    {% if user.is_staff %}
                    {% if challenge.status != 'winners_selected' %}
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="font-bold text-blue-800 mb-2">Admin Actions Available:</p>
                        <div class="flex flex-wrap gap-2">
                            {% if not challenge.draw_in_progress and winners_count == 0 %}
                            <a href="{% url 'club:challenge_live_draw' challenge.id %}"
                                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow">ğŸ¬
                                Start Live Draw</a>
                            {% elif challenge.draw_in_progress %}
                            <button onclick="resetDrawStatus()"
                                class="px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white font-bold rounded-lg shadow">ğŸ”„
                                Reset Draw Status</button>
                            {% endif %}
                        </div>
                    </div>
                    {% else %}
                    <div class="bg-emerald-50 border border-emerald-200 rounded-lg p-4">
                        <p class="font-bold text-emerald-800">âœ… Winners have been selected!</p>
                        <a href="{% url 'club:challenge_winners' challenge.id %}"
                            class="inline-block mt-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg shadow">View
                            Winners</a>
                    </div>
                    {% endif %}

                    {% if winners_count > 0 %}
                    <div class="mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="font-bold text-red-800 mb-1">âš ï¸ Warning: Winners exist in database</p>
                        <p class="text-xs text-red-600 mb-3">To redo the draw, you must reset the challenge first</p>
                        <button onclick="confirmReset()"
                            class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow text-sm">ğŸ—‘ï¸
                            Reset Challenge (Delete Winners)</button>
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="bg-gray-100 rounded-lg p-4 text-gray-600 text-center">
                        Login as staff to see admin actions
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- System Status Summary -->
        <div class="bg-gray-900 text-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold mb-4 border-b border-gray-700 pb-2">ğŸ¯ System Status Summary</h2>
            <div id="system-summary" class="font-mono text-sm text-gray-300">
                Loading system status...
            </div>
        </div>
    </div>

    <script>
        const challengeId = {{ challenge.id }};

        function refreshStatus() {
            location.reload();
        }

        function checkApiStatus() {
            fetch(`/club/challenge/${challengeId}/winners-status/`)
                .then(response => response.json())
                .then(data => {
                    // Display formatted response
                    document.getElementById('api-response').textContent = JSON.stringify(data, null, 2);

                    // Display status
                    const statusBox = document.getElementById('api-status');
                    let statusClass = 'bg-amber-50 border-amber-500 text-amber-900';

                    if (data.winners_selected) {
                        statusClass = 'bg-emerald-50 border-emerald-500 text-emerald-900';
                    } else if (data.draw_in_progress) {
                        statusClass = 'bg-blue-50 border-blue-500 text-blue-900';
                    }

                    statusBox.className = `rounded-lg p-4 font-mono text-sm border-l-4 ${statusClass}`;
                    statusBox.innerHTML = `
                        <strong>Challenge ID:</strong> ${data.challenge_id}<br>
                        <strong>Winners Selected:</strong> ${data.winners_selected ? 'âœ… Yes' : 'âŒ No'}<br>
                        <strong>Draw In Progress:</strong> ${data.draw_in_progress ? 'ğŸ”´ Yes' : 'âšª No'}<br>
                        <strong>Total Entries:</strong> ${data.total_entries}<br>
                        <strong>Winners Count:</strong> ${data.winners_count || 0}<br>
                        <strong>Has Winners:</strong> ${data.has_winners ? 'âœ… Yes' : 'âŒ No'}
                    `;

                    updateSystemSummary(data);
                })
                .catch(error => {
                    document.getElementById('api-status').innerHTML = `<span class="text-red-600 font-bold">âŒ Error: ${error}</span>`;
                    document.getElementById('api-response').textContent = 'Error: ' + error;
                });
        }

        function updateSystemSummary(apiData) {
            const summary = document.getElementById('system-summary');
            const dbWinners = {{ winners_count }
        };
        const eligible = {{ eligible_count }};
        const needed = {{ challenge.number_of_winners }};

        let status = [];

        const endDate = new Date("{{ challenge.end_date|date:'c' }}");
        const now = new Date();
        status.push(now > endDate ? 'âœ… Challenge has ended' : `âŒ Challenge still active (ends: ${endDate.toLocaleString()})`);

        status.push(eligible >= needed ? `âœ… Enough participants (${eligible} â‰¥ ${needed})` : `âŒ Not enough participants (${eligible} < ${needed})`);

        status.push((apiData.winners_selected || dbWinners > 0) ? `âœ… Winners selected (${dbWinners} winners in DB)` : 'â³ Winners not yet selected');

        status.push(apiData.draw_in_progress ? 'ğŸ”´ Draw currently in progress' : 'âšª Draw not in progress');

        status.push(apiData.winners_count === dbWinners ? 'âœ… API and DB are consistent' : `âš ï¸ API shows ${apiData.winners_count} winners, DB has ${dbWinners}`);

        summary.innerHTML = status.join('<br>');

        if (dbWinners > 0) {
            summary.innerHTML += '<br><br><strong class="text-emerald-400 text-lg">ğŸŠ DRAW COMPLETE - Winners selected!</strong>';
        } else if (now > endDate && eligible >= needed && !apiData.draw_in_progress) {
            summary.innerHTML += '<br><br><strong class="text-blue-400 text-lg">âœ… READY FOR DRAW</strong>';
        } else if (apiData.draw_in_progress) {
            summary.innerHTML += '<br><br><strong class="text-amber-400 text-lg">ğŸ”´ DRAW IN PROGRESS - Check admin page</strong>';
        } else {
            summary.innerHTML += '<br><br><strong class="text-amber-400 text-lg">â³ NOT READY - See issues above</strong>';
        }
        }

        function resetDrawStatus() {
            if (confirm('Reset draw_in_progress flag? This will NOT delete winners.')) {
                alert('Use Django Admin action: "Reset Draw Status"');
            }
        }

        function confirmReset() {
            if (confirm('âš ï¸ WARNING: This will DELETE all winners!\n\nAre you absolutely sure?')) {
                alert('Use command: python manage.py reset_challenge ' + challengeId + ' --confirm');
            }
        }

        function autoRefresh() {
            fetch(`/club/challenge/${challengeId}/winners-status/`)
                .then(response => response.json())
                .then(data => {
                    if (data.draw_in_progress) {
                        setTimeout(() => location.reload(), 10000);
                    }
                });
        }

        checkApiStatus();
        autoRefresh();
        setInterval(checkApiStatus, 5000);
    </script>
</body>

</html>