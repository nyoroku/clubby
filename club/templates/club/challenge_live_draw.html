{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üéâ {{ challenge.title }} - Live Draw!</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'melvins': {
                            'maroon': '#8b2332',
                            'maroon-dark': '#6a1b27',
                            'gold': '#d4a536',
                            'gold-light': '#e6bc52',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-slow': 'bounce 2s infinite',
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
        }

        .confetti {
            position: fixed;
            top: -10px;
            z-index: 9999;
            pointer-events: none;
        }

        @keyframes shuffle {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            50% {
                transform: translateY(-10px);
                opacity: 0.5;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .spinning {
            animation: shuffle 0.1s linear infinite;
        }

        @keyframes popIn {
            0% {
                transform: scale(0) rotate(-180deg);
            }

            100% {
                transform: scale(1) rotate(0);
            }
        }

        .animate-pop-in {
            animation: popIn 0.5s ease-out forwards;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-[#C17F59] to-[#2C1810] text-white overflow-x-hidden">

    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-4xl md:text-6xl font-extrabold text-white mb-4 drop-shadow-lg">üéâ {{ challenge.title }}</h1>
            <p class="text-xl md:text-2xl text-white/90 font-medium">{{ challenge.get_frequency_display }} Draw</p>
        </div>

        <!-- Stats Box -->
        <div class="bg-white/10 backdrop-blur-md rounded-2xl p-6 border border-white/20 shadow-xl mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                <div class="p-4 rounded-xl bg-black/20">
                    <p class="text-white/60 text-sm uppercase tracking-wider mb-1">Total Entries</p>
                    <p class="text-3xl font-bold text-white" id="total-entries">{{ total_entries }}</p>
                </div>
                <div class="p-4 rounded-xl bg-black/20">
                    <p class="text-white/60 text-sm uppercase tracking-wider mb-1">Winners to Select</p>
                    <p class="text-3xl font-bold text-white">{{ challenge.number_of_winners }}</p>
                </div>
                <div class="p-4 rounded-xl bg-black/20">
                    <p class="text-white/60 text-sm uppercase tracking-wider mb-1">Prize</p>
                    <p class="text-2xl font-bold text-melvins-gold">{{ challenge.reward_value }}</p>
                </div>
            </div>
        </div>

        <!-- Progress Tracker -->
        <div id="progress-tracker" style="display: none;" class="mb-8">
            <div class="text-center font-bold text-xl mb-4 text-white drop-shadow-md">
                Selecting Winner <span id="current-position" class="text-melvins-gold text-2xl">1</span> of {{
                challenge.number_of_winners }}
            </div>
            <div class="h-6 bg-black/30 rounded-full overflow-hidden border border-white/10">
                <div id="progress-fill"
                    class="h-full bg-gradient-to-r from-emerald-400 to-blue-500 transition-all duration-500 flex items-center justify-center text-xs font-bold"
                    style="width: 0%">
                    <span id="progress-text" class="px-2 drop-shadow-md">0%</span>
                </div>
            </div>
        </div>

        <!-- Draw Status -->
        <div id="draw-status" class="text-center py-8">
            <div id="pre-draw">
                <div id="countdown" style="display: none;"
                    class="text-8xl md:text-9xl font-black text-white mb-8 drop-shadow-2xl animate-pulse"></div>

                <button onclick="startDraw()"
                    class="group relative inline-flex items-center justify-center px-8 py-6 text-2xl font-bold text-white transition-all duration-200 bg-emerald-500 font-pj rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-600 hover:bg-emerald-600 shadow-lg hover:shadow-xl hover:-translate-y-1 animate-bounce-slow">
                    üé≤ Start the Draw!
                </button>

                <p
                    class="mt-6 text-white/80 font-medium bg-black/20 inline-block px-4 py-2 rounded-lg backdrop-blur-sm">
                    ‚ö†Ô∏è <strong>Important:</strong> Once started, share the public link for viewers to watch live!
                </p>
            </div>
        </div>

        <!-- Wheel/Display Container -->
        <div id="wheel-container" style="display: none;" class="flex justify-center mb-12">
            <div
                class="relative w-80 h-80 md:w-96 md:h-96 bg-white rounded-full shadow-[0_0_50px_rgba(255,255,255,0.3)] flex items-center justify-center border-8 border-melvins-gold overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-br from-white to-gray-100 opacity-50"></div>
                <div id="phone-display"
                    class="relative z-10 text-4xl md:text-5xl font-black text-[#C17F59] tracking-widest text-center">
                    +254...
                </div>
            </div>
        </div>

        <!-- Winners Display -->
        <div id="winners-container" class="space-y-6"></div>

        <!-- Share Buttons (shown after draw) -->
        <div id="share-section" style="display: none;" class="text-center mt-12 animate-pop-in">
            <div class="bg-white/10 backdrop-blur-xl rounded-2xl p-8 border border-white/20 shadow-2xl">
                <h3 class="text-3xl font-bold text-white mb-4">üéä Congratulations to all winners!</h3>
                <p class="text-white/80 mb-8">Share this exciting moment on social media!</p>

                <div class="flex flex-col md:flex-row items-center justify-center gap-4">
                    <button onclick="shareOnTwitter()"
                        class="w-full md:w-auto px-6 py-3 bg-[#1DA1F2] hover:bg-[#1a91da] text-white font-bold rounded-xl transition shadow-lg flex items-center justify-center gap-2">
                        <span>üê¶</span> Share on Twitter
                    </button>
                    <button onclick="shareOnWhatsApp()"
                        class="w-full md:w-auto px-6 py-3 bg-[#25D366] hover:bg-[#20bd5a] text-white font-bold rounded-xl transition shadow-lg flex items-center justify-center gap-2">
                        <span>üí¨</span> Share on WhatsApp
                    </button>
                    <a href="{% url 'club:challenge_winners' challenge.id %}"
                        class="w-full md:w-auto px-6 py-3 bg-white/20 hover:bg-white/30 text-white font-bold rounded-xl transition shadow-lg backdrop-blur-md">
                        View Winners Page
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const challengeId = {{ challenge.id }};
        const numberOfWinners = {{ challenge.number_of_winners }};
        const totalEntries = {{ total_entries }};
        let currentWinnerIndex = 0;
        let isSpinning = false;

        // Sample phone numbers for animation
        const dummyPhones = [
            '+254712***345', '+254723***678', '+254734***901',
            '+254745***234', '+254756***567', '+254767***890',
            '+254778***123', '+254789***456', '+254790***789'
        ];

        function startDraw() {
            document.getElementById('pre-draw').style.display = 'none';
            const countdownEl = document.getElementById('countdown');
            countdownEl.style.display = 'block';

            let count = 5;
            countdownEl.textContent = count;

            const countInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownEl.textContent = count;
                } else {
                    countdownEl.textContent = "LET'S GO! üéâ";
                    countdownEl.classList.remove('animate-pulse');
                    countdownEl.classList.add('animate-bounce');
                    clearInterval(countInterval);

                    setTimeout(() => {
                        countdownEl.style.display = 'none';
                        document.getElementById('wheel-container').style.display = 'flex';
                        document.getElementById('progress-tracker').style.display = 'block';
                        selectWinners();
                    }, 1000);
                }
            }, 1000);
        }

        function selectWinners() {
            fetch(`/club/challenge/${challengeId}/select-winners/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        if (data.already_selected) {
                            console.log('Winners already selected, displaying them...');
                        }
                        animateWinnerSelection(data.winners);
                    } else {
                        alert('Error: ' + data.error);
                        setTimeout(() => location.reload(), 2000);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to select winners. The page will reload to check status.');
                    setTimeout(() => location.reload(), 2000);
                });
        }

        function animateWinnerSelection(winners) {
            spinAndReveal(winners, 0);
        }

        function spinAndReveal(winners, index) {
            if (index >= winners.length) {
                finishDraw();
                return;
            }

            const progress = ((index + 1) / winners.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = Math.round(progress) + '%';
            document.getElementById('current-position').textContent = index + 1;

            const phoneDisplay = document.getElementById('phone-display');
            phoneDisplay.classList.add('spinning');
            isSpinning = true;

            let shuffleCount = 0;
            const maxShuffles = 80 + (index * 30);

            const shuffleInterval = setInterval(() => {
                const randomPhone = dummyPhones[Math.floor(Math.random() * dummyPhones.length)];
                phoneDisplay.textContent = randomPhone;
                shuffleCount++;

                if (shuffleCount >= maxShuffles) {
                    clearInterval(shuffleInterval);

                    setTimeout(() => {
                        phoneDisplay.classList.remove('spinning');
                        phoneDisplay.textContent = winners[index].masked_phone;
                        createConfetti();

                        setTimeout(() => {
                            displayWinner(winners[index], index + 1);
                            setTimeout(() => {
                                spinAndReveal(winners, index + 1);
                            }, 5000);
                        }, 2000);
                    }, 500);
                }
            }, 50);
        }

        function displayWinner(winner, position) {
            const container = document.getElementById('winners-container');
            const card = document.createElement('div');
            card.className = 'bg-white rounded-2xl p-6 shadow-xl animate-pop-in border-l-8 border-melvins-gold';

            card.innerHTML = `
                <div class="flex items-center gap-6">
                    <div class="flex-shrink-0">
                        <div class="w-20 h-20 bg-gradient-to-br from-[#f6d365] to-[#fda085] rounded-full flex items-center justify-center text-4xl shadow-lg border-4 border-white">
                            ${getPositionEmoji(position)}
                        </div>
                    </div>
                    <div class="flex-grow">
                        <h3 class="text-xl font-bold text-gray-400 uppercase tracking-wide mb-1">${getPositionText(position)} Place Winner</h3>
                        <p class="text-3xl font-black text-[#C17F59] mb-1 font-mono tracking-wider">${winner.masked_phone}</p>
                        <p class="text-xl font-bold text-gray-800 mb-2">üë§ ${winner.display_name}</p>
                        
                        <div class="flex flex-wrap gap-4 text-sm text-gray-600 bg-gray-50 p-3 rounded-lg">
                            <span class="flex items-center gap-1">üìç <strong>County:</strong> ${winner.county || 'Not specified'}</span>
                            <span class="flex items-center gap-1">üìä <strong>Weight:</strong> ${Number(winner.entry_weight).toFixed(2)}</span>
                            <span class="flex items-center gap-1">üéÅ <strong>Prize:</strong> ${winner.prize}</span>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(card);
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function getPositionEmoji(position) {
            if (position === 1) return 'ü•á';
            if (position === 2) return 'ü•à';
            if (position === 3) return 'ü•â';
            return position;
        }

        function getPositionText(position) {
            const suffixes = ['st', 'nd', 'rd'];
            const suffix = position <= 3 ? suffixes[position - 1] : 'th';
            return position + suffix;
        }

        function createConfetti() {
            const colors = ['#f6d365', '#fda085', '#C17F59', '#2C1810', '#48c6ef'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * window.innerWidth + 'px';
                confetti.style.width = (Math.random() * 10 + 5) + 'px';
                confetti.style.height = confetti.style.width;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animation = `fall ${Math.random() * 3 + 2}s linear`;
                confetti.style.borderRadius = '50%';
                document.body.appendChild(confetti);
                setTimeout(() => confetti.remove(), 5000);
            }
        }

        function finishDraw() {
            document.getElementById('wheel-container').style.display = 'none';
            document.getElementById('progress-tracker').style.display = 'none';
            document.getElementById('share-section').style.display = 'block';
            createConfetti();
            setTimeout(createConfetti, 500);
            setTimeout(createConfetti, 1000);
        }

        function shareOnTwitter() {
            const text = `üéâ Just witnessed the live draw for {{ challenge.title|escapejs }}! ${numberOfWinners} lucky winners selected! #LoyaltyClub #GiveAway`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareOnWhatsApp() {
            const text = `üéâ Amazing! Just saw the live draw for {{ challenge.title|escapejs }}! ${numberOfWinners} winners selected live!`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }
    </script>
</body>

</html>