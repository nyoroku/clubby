{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>üéâ {{ challenge.title }} - Live Draw!</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #C17F59 0%, #2C1810 100%);
            min-height: 100vh;
        }

        .draw-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
        }

        .wheel-container {
            position: relative;
            width: 400px;
            height: 400px;
            margin: 2rem auto;
            background: white;
            border-radius: 50%;
            box-shadow: 0 10px 50px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .phone-display {
            font-size: 2.5rem;
            font-weight: bold;
            color: #C17F59;
            text-align: center;
            letter-spacing: 2px;
            animation: pulse 1s ease-in-out infinite;
        }

        .phone-display.spinning {
            animation: shuffle 0.1s linear infinite;
        }

        @keyframes shuffle {
            0% { transform: translateY(0); opacity: 1; }
            50% { transform: translateY(-10px); opacity: 0.5; }
            100% { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .confetti {
            position: fixed;
            top: -10px;
            z-index: 9999;
            pointer-events: none;
        }

        .winner-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            transform: scale(0);
            animation: popIn 0.5s ease-out forwards;
        }

        @keyframes popIn {
            0% { transform: scale(0) rotate(-180deg); }
            100% { transform: scale(1) rotate(0); }
        }

        .position-badge {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .countdown {
            font-size: 6rem;
            font-weight: bold;
            color: white;
            text-align: center;
            text-shadow: 2px 2px 10px rgba(0,0,0,0.3);
        }

        .stats-box {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .start-button {
            font-size: 1.5rem;
            padding: 1.5rem 3rem;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .current-winner {
            font-size: 1.2rem;
            text-align: center;
            margin: 1rem 0;
            color: white;
        }

        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 1rem 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, #10b981, #3b82f6);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="draw-container">
        <!-- Header -->
        <div class="has-text-centered mb-6">
            <h1 class="title is-1 has-text-white">üéâ {{ challenge.title }}</h1>
            <p class="subtitle is-4 has-text-white">{{ challenge.get_frequency_display }} Draw</p>
        </div>

        <!-- Stats Box -->
        <div class="stats-box">
            <div class="columns is-mobile has-text-centered">
                <div class="column">
                    <p class="heading">Total Entries</p>
                    <p class="title is-3" id="total-entries">{{ total_entries }}</p>
                </div>
                <div class="column">
                    <p class="heading">Winners to Select</p>
                    <p class="title is-3">{{ challenge.number_of_winners }}</p>
                </div>
                <div class="column">
                    <p class="heading">Prize</p>
                    <p class="title is-5">{{ challenge.reward_value }}</p>
                </div>
            </div>
        </div>

        <!-- Progress Tracker -->
        <div id="progress-tracker" style="display: none;">
            <div class="current-winner has-text-white has-text-centered">
                <strong>Selecting Winner <span id="current-position">1</span> of {{ challenge.number_of_winners }}</strong>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%">
                    <span id="progress-text">0%</span>
                </div>
            </div>
        </div>

        <!-- Draw Status -->
        <div id="draw-status" class="has-text-centered">
            <div id="pre-draw">
                <div class="countdown mb-6" id="countdown" style="display: none;"></div>
                <button class="button is-success is-large start-button" onclick="startDraw()">
                    üé≤ Start the Draw!
                </button>
                <p class="has-text-white mt-4">
                    <strong>‚ö†Ô∏è Important:</strong> Once started, share the public link for viewers to watch live!
                </p>
            </div>
        </div>

        <!-- Wheel/Display Container -->
        <div class="wheel-container" id="wheel-container" style="display: none;">
            <div class="phone-display" id="phone-display">
                +254712***678
            </div>
        </div>

        <!-- Winners Display -->
        <div id="winners-container"></div>

        <!-- Share Buttons (shown after draw) -->
        <div id="share-section" style="display: none;" class="has-text-centered mt-6">
            <div class="stats-box">
                <h3 class="title is-4">üéä Congratulations to all winners!</h3>
                <p class="content">Share this exciting moment on social media!</p>
                <div class="buttons is-centered">
                    <button class="button is-link" onclick="shareOnTwitter()">
                        Share on Twitter
                    </button>
                    <button class="button is-success" onclick="shareOnWhatsApp()">
                        Share on WhatsApp
                    </button>
                    <a href="{% url 'club:challenge_winners' challenge.id %}" class="button is-info">
                        View Winners Page
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script>
        const challengeId = {{ challenge.id }};
        const numberOfWinners = {{ challenge.number_of_winners }};
        const totalEntries = {{ total_entries }};
        let currentWinnerIndex = 0;
        let isSpinning = false;

        // Sample phone numbers for animation (will be replaced with real winners)
        const dummyPhones = [
            '+254712***345', '+254723***678', '+254734***901',
            '+254745***234', '+254756***567', '+254767***890',
            '+254778***123', '+254789***456', '+254790***789'
        ];

        function startDraw() {
            document.getElementById('pre-draw').style.display = 'none';

            // Show countdown
            const countdownEl = document.getElementById('countdown');
            countdownEl.style.display = 'block';

            let count = 5; // 5 second countdown for viewers to get ready
            countdownEl.textContent = count;

            const countInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownEl.textContent = count;
                } else {
                    countdownEl.textContent = "LET'S GO! üéâ";
                    clearInterval(countInterval);

                    setTimeout(() => {
                        countdownEl.style.display = 'none';
                        document.getElementById('wheel-container').style.display = 'flex';
                        document.getElementById('progress-tracker').style.display = 'block';

                        // Start selecting winners
                        selectWinners();
                    }, 1000);
                }
            }, 1000);
        }

        function selectWinners() {
            // Call backend to select all winners at once
            fetch(`/club/challenge/${challengeId}/select-winners/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.already_selected) {
                        // Winners were already selected, show them immediately
                        console.log('Winners already selected, displaying them...');
                    }
                    // Animate revealing winners one by one
                    animateWinnerSelection(data.winners);
                } else {
                    alert('Error: ' + data.error);
                    // Reload page to see current state
                    setTimeout(() => location.reload(), 2000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to select winners. The page will reload to check status.');
                setTimeout(() => location.reload(), 2000);
            });
        }

        function animateWinnerSelection(winners) {
            // Reveal winners one by one with dramatic pauses
            spinAndReveal(winners, 0);
        }

        function spinAndReveal(winners, index) {
            if (index >= winners.length) {
                // All winners revealed
                finishDraw();
                return;
            }

            // Update progress
            const progress = ((index + 1) / winners.length) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
            document.getElementById('progress-text').textContent = Math.round(progress) + '%';
            document.getElementById('current-position').textContent = index + 1;

            const phoneDisplay = document.getElementById('phone-display');
            phoneDisplay.classList.add('spinning');
            isSpinning = true;

            // Dramatic shuffle animation - longer for more suspense
            let shuffleCount = 0;
            const maxShuffles = 80 + (index * 30); // Gets longer each time

            const shuffleInterval = setInterval(() => {
                const randomPhone = dummyPhones[Math.floor(Math.random() * dummyPhones.length)];
                phoneDisplay.textContent = randomPhone;
                shuffleCount++;

                if (shuffleCount >= maxShuffles) {
                    clearInterval(shuffleInterval);

                    // Slow down before reveal
                    setTimeout(() => {
                        phoneDisplay.classList.remove('spinning');
                        phoneDisplay.textContent = winners[index].masked_phone;

                        // Confetti!
                        createConfetti();

                        // Show winner card after 2 seconds
                        setTimeout(() => {
                            displayWinner(winners[index], index + 1);

                            // Pause before next winner (5 seconds for viewing)
                            setTimeout(() => {
                                spinAndReveal(winners, index + 1);
                            }, 5000);
                        }, 2000);
                    }, 500);
                }
            }, 50);
        }

        function displayWinner(winner, position) {
            const container = document.getElementById('winners-container');

            const card = document.createElement('div');
            card.className = 'winner-card';

            card.innerHTML = `
                <div class="columns is-vcentered">
                    <div class="column is-narrow">
                        <div class="position-badge">
                            ${getPositionEmoji(position)}
                        </div>
                    </div>
                    <div class="column">
                        <h3 class="title is-3">${getPositionText(position)} Place Winner</h3>
                        <div class="content">
                            <p class="title is-4" style="color: #C17F59; margin-bottom: 0.5rem;">
                                üì± ${winner.masked_phone}
                            </p>
                            <p class="subtitle is-5" style="margin-bottom: 0.5rem;">
                                üë§ ${winner.display_name}
                            </p>
                            <p style="color: #6b7280;">
                                üìç <strong>County:</strong> ${winner.county || 'Not specified'}<br>
                                üìä <strong>Entry Weight:</strong> ${winner.entry_weight.toFixed(2)}<br>
                                üéÅ <strong>Prize:</strong> ${winner.prize}
                            </p>
                        </div>
                    </div>
                </div>
            `;

            container.appendChild(card);

            // Scroll to show the new winner
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function getPositionEmoji(position) {
            if (position === 1) return 'ü•á';
            if (position === 2) return 'ü•à';
            if (position === 3) return 'ü•â';
            return position;
        }

        function getPositionText(position) {
            const suffixes = ['st', 'nd', 'rd'];
            const suffix = position <= 3 ? suffixes[position - 1] : 'th';
            return position + suffix;
        }

        function createConfetti() {
            const colors = ['#f6d365', '#fda085', '#C17F59', '#2C1810', '#48c6ef'];

            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * window.innerWidth + 'px';
                confetti.style.width = (Math.random() * 10 + 5) + 'px';
                confetti.style.height = confetti.style.width;
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animation = `fall ${Math.random() * 3 + 2}s linear`;
                confetti.style.position = 'fixed';
                confetti.style.borderRadius = '50%';

                document.body.appendChild(confetti);

                setTimeout(() => confetti.remove(), 5000);
            }
        }

        function finishDraw() {
            document.getElementById('wheel-container').style.display = 'none';
            document.getElementById('progress-tracker').style.display = 'none';
            document.getElementById('share-section').style.display = 'block';

            // Final celebration confetti!
            createConfetti();
            setTimeout(createConfetti, 500);
            setTimeout(createConfetti, 1000);
        }

        function shareOnTwitter() {
            const text = `üéâ Just witnessed the live draw for {{ challenge.title|escapejs }}! ${numberOfWinners} lucky winners selected! #LoyaltyClub #GiveAway`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`, '_blank');
        }

        function shareOnWhatsApp() {
            const text = `üéâ Amazing! Just saw the live draw for {{ challenge.title|escapejs }}! ${numberOfWinners} winners selected live!`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }
    </script>

    <style>
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }
    </style>
</body>
</html>




