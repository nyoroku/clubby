{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ğŸ”´ LIVE: {{ challenge.title }}</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'melvins': {
                            'maroon': '#8b2332',
                            'maroon-dark': '#6a1b27',
                            'gold': '#d4a536',
                            'gold-light': '#e6bc52',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin-slow': 'spin 3s linear infinite',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
        }

        @keyframes slideInBounce {
            0% {
                transform: translateY(-100px) scale(0.5);
                opacity: 0;
            }

            60% {
                transform: translateY(20px) scale(1.05);
                opacity: 1;
            }

            100% {
                transform: translateY(0) scale(1);
            }
        }

        .animate-slide-in {
            animation: slideInBounce 0.8s ease-out;
        }

        .confetti {
            position: fixed;
            top: -10px;
            z-index: 9999;
            pointer-events: none;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-[#C17F59] to-[#2C1810] text-white overflow-x-hidden flex flex-col">

    <div class="flex-grow w-full max-w-7xl mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-12">
            <div
                class="inline-block bg-red-600 text-white px-6 py-2 rounded-full text-xl font-bold animate-pulse mb-4 shadow-lg border-2 border-red-400">
                ğŸ”´ LIVE DRAW
            </div>

            <h1 class="text-4xl md:text-6xl font-black text-white mb-4 drop-shadow-xl">{{ challenge.title }}</h1>
            <div class="text-3xl md:text-4xl font-bold text-melvins-gold drop-shadow-md">ğŸ {{ challenge.reward_value }}
            </div>

            <!-- Viewer Count -->
            <div
                class="mt-4 inline-flex items-center gap-2 bg-black/30 px-4 py-2 rounded-full backdrop-blur-sm border border-white/10">
                <span class="animate-pulse text-green-400">â—</span>
                <span id="viewer-count" class="text-white/80 font-mono">ğŸ‘¥ Loading...</span>
            </div>
        </div>

        <!-- Winners Display -->
        {% if winners %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12" id="winners-container">
            {% for winner in winners %}
            <div
                class="relative bg-white/95 text-gray-800 rounded-3xl p-8 shadow-2xl animate-slide-in transform hover:-translate-y-2 transition duration-300
                {% if winner.position == 1 %}border-4 border-yellow-400 bg-gradient-to-br from-yellow-50 to-white{% endif %}
                {% if winner.position == 2 %}border-4 border-gray-300 bg-gradient-to-br from-gray-50 to-white{% endif %}
                {% if winner.position == 3 %}border-4 border-orange-400 bg-gradient-to-br from-orange-50 to-white{% endif %}">

                <div class="text-6xl text-center mb-4">
                    {% if winner.position == 1 %}ğŸ¥‡
                    {% elif winner.position == 2 %}ğŸ¥ˆ
                    {% elif winner.position == 3 %}ğŸ¥‰
                    {% else %}ğŸ†
                    {% endif %}
                </div>

                <div class="text-3xl font-black text-center text-[#C17F59] mb-2 font-mono tracking-widest">
                    {{ winner.get_masked_phone }}
                </div>

                <div class="text-2xl font-bold text-center text-gray-800 mb-2">
                    {{ winner.get_display_name }}
                </div>

                <div class="text-xl text-center text-gray-500 font-medium">
                    ğŸ“ {{ winner.profile.get_county_display|default:"Kenya" }}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Share Section -->
        <div
            class="max-w-2xl mx-auto bg-white/10 backdrop-blur-xl rounded-2xl p-8 border border-white/20 text-center animate-fade-in-up">
            <h3 class="text-2xl font-bold text-white mb-6">Share the Excitement!</h3>
            <div class="flex flex-wrap justify-center gap-4">
                <button onclick="shareOnTwitter()"
                    class="px-6 py-3 bg-[#1DA1F2] hover:bg-[#1a91da] text-white font-bold rounded-xl transition shadow-lg flex items-center gap-2 transform hover:scale-105">
                    <span>ğŸ¦</span> Share on Twitter
                </button>
                <button onclick="shareOnWhatsApp()"
                    class="px-6 py-3 bg-[#25D366] hover:bg-[#20bd5a] text-white font-bold rounded-xl transition shadow-lg flex items-center gap-2 transform hover:scale-105">
                    <span>ğŸ’¬</span> Share on WhatsApp
                </button>
                <a href="{% url 'club:challenge_winners' challenge.id %}"
                    class="px-6 py-3 bg-white/20 hover:bg-white/30 text-white font-bold rounded-xl transition shadow-lg backdrop-blur-md transform hover:scale-105">
                    ğŸ† View Full Results
                </a>
            </div>
        </div>

        {% else %}
        <!-- Waiting State -->
        <div class="flex flex-col items-center justify-center min-h-[40vh] text-center space-y-8">
            <div class="relative w-32 h-32">
                <div class="absolute inset-0 border-8 border-white/20 rounded-full"></div>
                <div
                    class="absolute inset-0 border-8 border-t-white border-l-transparent border-b-transparent border-r-transparent rounded-full animate-spin">
                </div>
            </div>
            <div>
                <h2 class="text-4xl md:text-5xl font-bold text-white mb-2 drop-shadow-lg">Draw in Progress...</h2>
                <p class="text-xl text-white/70">Winners are being selected live!</p>
            </div>
            <div class="bg-black/20 px-6 py-3 rounded-xl border border-white/10 text-sm text-white/50">
                ğŸ”„ This page automatically refreshes every 5 seconds
                <br>
                <span class="text-xs">Last updated: <span id="last-update" class="font-mono text-melvins-gold">{{
                        now|date:"H:i:s" }}</span></span>
            </div>
        </div>
        {% endif %}

        <!-- Challenge Info Footer -->
        <div
            class="mt-12 max-w-3xl mx-auto bg-black/20 backdrop-blur-md rounded-xl p-6 border border-white/5 text-center text-white/60 text-sm">
            <p class="mb-2"><strong>Loyalty Club</strong> - Fair and Transparent Draws</p>
            <div class="flex justify-center gap-4">
                <a href="{% url 'club:challenges_list' %}" class="hover:text-white transition underline">View All
                    Challenges</a>
                <span>â€¢</span>
                <a href="{% url 'club:dashboard' %}" class="hover:text-white transition underline">Dashboard</a>
            </div>
        </div>
    </div>

    <script>
        const challengeId = {{ challenge.id }};
        let checkCount = 0;
        const maxChecks = 120;
        let currentWinnerCount = {{ winners| length }};

        // Update viewer count simulation
        function updateViewerCount() {
            const baseCount = {{ total_entries }
        };
        const viewers = Math.floor(baseCount / 3) + Math.floor(Math.random() * 10) + 5;
        document.getElementById('viewer-count').textContent = `ğŸ‘¥ ${viewers} watching`;
        }

        function updateTime() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
        }

        function checkForWinners() {
            fetch(`/club/challenge/${challengeId}/winners-status/`)
                .then(response => response.json())
                .then(data => {
                    if (data.has_winners && data.winners_count > currentWinnerCount) {
                        location.reload();
                    } else if (data.winners_selected && !data.draw_in_progress) {
                        location.reload();
                    }
                })
                .catch(error => console.log('Checking...'));
        }

        updateViewerCount();

        {% if not winners %}
        const checkInterval = setInterval(() => {
            updateTime();
            updateViewerCount();
            checkForWinners();
            checkCount++;

            if (checkCount >= maxChecks) {
                clearInterval(checkInterval);
                location.reload(); // Hard refresh after timeout
            }
        }, 5000);
        {% else %}
        // Winners shown, create massive confetti
        window.addEventListener('load', () => {
            createMassiveConfetti();
            setTimeout(createMassiveConfetti, 1000);
            setTimeout(createMassiveConfetti, 2000);
        });

        setInterval(updateTime, 10000);
        setInterval(updateViewerCount, 15000);
        {% endif %}

        function createMassiveConfetti() {
            const colors = ['#f6d365', '#fda085', '#C17F59', '#2C1810', '#48c6ef', '#ffd700', '#ff6b6b'];

            for (let i = 0; i < 100; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.position = 'fixed';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.top = '-20px';
                    confetti.style.width = (Math.random() * 15 + 10) + 'px';
                    confetti.style.height = confetti.style.width;
                    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                    confetti.style.animation = `fall ${Math.random() * 3 + 3}s linear`;
                    confetti.style.zIndex = '9999';

                    document.body.appendChild(confetti);

                    setTimeout(() => confetti.remove(), 6000);
                }, i * 30);
            }
        }

        function shareOnTwitter() {
            const text = `ğŸ‰ {{ challenge.title|escapejs }} winners just announced! Congratulations to all! #LoyaltyClub #Winners`;
            const url = window.location.href;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
        }

        function shareOnWhatsApp() {
            const text = `ğŸ‰ {{ challenge.title|escapejs }} winners announced! Check them out: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }
    </script>
</body>

</html>